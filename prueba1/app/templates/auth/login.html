{% extends "base.html" %}

{% block title %}Iniciar Sesi√≥n - Portal de Turismo Inclusivo{% endblock %}

{% block content %}
<div class="auth-page">
    <div class="container">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1 class="auth-title">Iniciar Sesi√≥n</h1>
                    <p class="auth-subtitle">
                        Accede a tu cuenta para guardar destinos favoritos y escribir rese√±as
                    </p>
                </div>
                
                <form method="POST" class="auth-form" id="login-form" novalidate>
                    <!-- Campo de usuario/email con validaci√≥n en tiempo real -->
                    <div class="form-group">
                        <label for="email_or_username" class="form-label required">
                            Email o Nombre de Usuario
                            <span class="required-indicator" aria-label="Campo obligatorio">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-icon" aria-hidden="true">üë§</span>
                            <input type="text" 
                                   id="email_or_username" 
                                   name="email_or_username" 
                                   class="form-control"
                                   required 
                                   autocomplete="username"
                                   aria-describedby="email-help email-error"
                                   placeholder="Ingresa tu email o nombre de usuario"
                                   autofocus>
                        </div>
                        <div id="email-help" class="form-help">
                            Puedes usar tu email o nombre de usuario
                        </div>
                        <div id="email-error" class="form-error" role="alert" aria-live="polite"></div>
                    </div>
                    
                    <!-- Campo de contrase√±a con toggle -->
                    <div class="form-group">
                        <label for="password" class="form-label required">
                            Contrase√±a
                            <span class="required-indicator" aria-label="Campo obligatorio">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-icon" aria-hidden="true">üîí</span>
                            <input type="password" 
                                   id="password" 
                                   name="password" 
                                   class="form-control"
                                   required 
                                   autocomplete="current-password"
                                   aria-describedby="password-help password-error"
                                   placeholder="Ingresa tu contrase√±a">
                            <button type="button" 
                                    class="password-toggle" 
                                    aria-label="Mostrar contrase√±a"
                                    aria-pressed="false">
                                <span class="toggle-icon" aria-hidden="true">üëÅÔ∏è</span>
                            </button>
                        </div>
                        <div id="password-help" class="form-help">
                            M√≠nimo 8 caracteres
                        </div>
                        <div id="password-error" class="form-error" role="alert" aria-live="polite"></div>
                    </div>
                    
                    <!-- Opciones adicionales -->
                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" 
                                   name="remember_me" 
                                   id="remember_me"
                                   aria-describedby="remember-help">
                            <span class="checkmark"></span>
                            Recordarme en este dispositivo
                        </label>
                        <div id="remember-help" class="form-help">
                            Mantendr√° tu sesi√≥n activa por 30 d√≠as
                        </div>
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div class="form-actions">
                        <button type="submit" 
                                class="btn btn-primary btn-block btn-lg"
                                id="login-submit"
                                aria-describedby="submit-help">
                            <span class="btn-icon" aria-hidden="true">üîë</span>
                            Iniciar Sesi√≥n
                            <span class="btn-loading" aria-hidden="true" style="display: none;">
                                <span class="spinner"></span>
                            </span>
                        </button>
                        <div id="submit-help" class="form-help">
                            Presiona Enter o haz clic en el bot√≥n para continuar
                        </div>
                    </div>
                    
                    <!-- Mensajes de estado -->
                    <div id="form-messages" class="form-messages" role="region" aria-live="polite"></div>
                </form>
                
                <!-- Enlaces adicionales -->
                <div class="auth-footer">
                    <div class="auth-links">
                        <p>
                            ¬øNo tienes cuenta? 
                            <a href="{{ url_for('auth.register') }}" class="auth-link">
                                Reg√≠strate aqu√≠
                            </a>
                        </p>
                        <p>
                            <a href="#" class="auth-link" id="forgot-password">
                                ¬øOlvidaste tu contrase√±a?
                            </a>
                        </p>
                    </div>
                    
                    <!-- Informaci√≥n de seguridad -->
                    <div class="security-info">
                        <p class="security-text">
                            <span class="icon" aria-hidden="true">üîí</span>
                            Tu informaci√≥n est√° protegida con encriptaci√≥n SSL
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de recuperaci√≥n de contrase√±a -->
<div id="forgot-password-modal" class="modal" role="dialog" aria-labelledby="forgot-password-title" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="forgot-password-title">üîë Recuperar Contrase√±a</h5>
                <button type="button" class="close" aria-label="Cerrar modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="small mb-3">Ingresa tu email para recibir instrucciones.</p>
                <form id="forgot-password-form" class="forgot-password-form">
                    <div class="form-group">
                        <label for="recovery-email" class="form-label required">
                            Email
                            <span class="required-indicator" aria-label="Campo obligatorio">*</span>
                        </label>
                        <input type="email" 
                               id="recovery-email" 
                               name="email" 
                               class="form-control form-control-sm"
                               required
                               autocomplete="email"
                               placeholder="tu@email.com">
                    </div>
                    <div class="form-actions mt-3">
                        <button type="submit" class="btn btn-primary btn-sm">
                            üì§ Enviar
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-dismiss="modal">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('login-form');
    const emailField = document.getElementById('email_or_username');
    const passwordField = document.getElementById('password');
    const submitBtn = document.getElementById('login-submit');
    const passwordToggle = document.querySelector('.password-toggle');
    
    // Validaci√≥n en tiempo real
    function validateField(field, type) {
        const value = field.value.trim();
        const errorElement = document.getElementById(field.id + '-error');
        let isValid = true;
        let errorMessage = '';
        
        // Remover clases de error previas
        field.classList.remove('is-invalid', 'is-valid');
        errorElement.textContent = '';
        
        // Validaciones espec√≠ficas
        if (type === 'email_or_username') {
            if (!value) {
                isValid = false;
                errorMessage = 'Por favor, ingresa tu email o nombre de usuario';
            } else if (value.includes('@')) {
                // Validar formato de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                    isValid = false;
                    errorMessage = 'Por favor, ingresa un email v√°lido';
                }
            } else if (value.length < 3) {
                isValid = false;
                errorMessage = 'El nombre de usuario debe tener al menos 3 caracteres';
            }
        } else if (type === 'password') {
            if (!value) {
                isValid = false;
                errorMessage = 'Por favor, ingresa tu contrase√±a';
            } else if (value.length < 8) {
                isValid = false;
                errorMessage = 'La contrase√±a debe tener al menos 8 caracteres';
            }
        }
        
        // Aplicar resultado de validaci√≥n
        if (isValid) {
            field.classList.add('is-valid');
        } else {
            field.classList.add('is-invalid');
            errorElement.textContent = errorMessage;
        }
        
        return isValid;
    }
    
    // Eventos de validaci√≥n en tiempo real
    emailField.addEventListener('blur', () => validateField(emailField, 'email_or_username'));
    emailField.addEventListener('input', () => {
        if (emailField.classList.contains('is-invalid')) {
            validateField(emailField, 'email_or_username');
        }
    });
    
    passwordField.addEventListener('blur', () => validateField(passwordField, 'password'));
    passwordField.addEventListener('input', () => {
        if (passwordField.classList.contains('is-invalid')) {
            validateField(passwordField, 'password');
        }
    });
    
    // Toggle de contrase√±a
    passwordToggle.addEventListener('click', function() {
        const isVisible = passwordField.type === 'text';
        passwordField.type = isVisible ? 'password' : 'text';
        this.setAttribute('aria-pressed', !isVisible);
        this.querySelector('.toggle-icon').textContent = isVisible ? 'üëÅÔ∏è' : 'üôà';
    });
    
    // Validaci√≥n del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const isEmailValid = validateField(emailField, 'email_or_username');
        const isPasswordValid = validateField(passwordField, 'password');
        
        if (isEmailValid && isPasswordValid) {
            // Mostrar estado de carga
            submitBtn.disabled = true;
            submitBtn.querySelector('.btn-loading').style.display = 'inline-block';
            submitBtn.querySelector('.btn-icon').style.display = 'none';
            
            // Enviar formulario
            form.submit();
        } else {
            // Enfocar el primer campo con error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.focus();
            }
        }
    });
    
    // Modal de recuperaci√≥n de contrase√±a
    const forgotPasswordLink = document.getElementById('forgot-password');
    const forgotPasswordModal = document.getElementById('forgot-password-modal');
    
    forgotPasswordLink.addEventListener('click', function(e) {
        e.preventDefault();
        forgotPasswordModal.setAttribute('aria-hidden', 'false');
        forgotPasswordModal.style.display = 'block';
        document.getElementById('recovery-email').focus();
    });
    
    // Cerrar modal
    const closeButtons = forgotPasswordModal.querySelectorAll('.close, [data-dismiss="modal"]');
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            forgotPasswordModal.setAttribute('aria-hidden', 'true');
            forgotPasswordModal.style.display = 'none';
        });
    });
    
    // Cerrar modal con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && forgotPasswordModal.getAttribute('aria-hidden') === 'false') {
            forgotPasswordModal.setAttribute('aria-hidden', 'true');
            forgotPasswordModal.style.display = 'none';
        }
    });
    
    // Formulario de recuperaci√≥n
    const forgotPasswordForm = document.getElementById('forgot-password-form');
    forgotPasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        // Aqu√≠ ir√≠a la l√≥gica de recuperaci√≥n de contrase√±a
        alert('Funcionalidad de recuperaci√≥n de contrase√±a en desarrollo');
    });
    
    // Anunciar a lectores de pantalla
    if (window.accessibility) {
        window.accessibility.announceToScreenReader('P√°gina de inicio de sesi√≥n cargada. Usa Tab para navegar entre los campos.');
    }
});
</script>
{% endblock %} 