<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Destino Turístico</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <main id="main-content" role="main">
    <div class="modal-content registro-modal" style="max-width:600px;margin:2rem auto;box-shadow:0 0 10px #0002;">
      <h2>Editar Registro</h2>
      <form id="form-editar" role="form" aria-describedby="editar-descripcion" autocomplete="on">
        <p id="editar-descripcion" class="sr-only">Formulario para editar un registro existente</p>
        <fieldset>
          <legend>Datos principales</legend>
          <div class="form-group">
            <label for="id">ID</label>
            <input type="text" id="id" name="id" value="{{ registro.id }}" disabled />
          </div>
          <div class="form-group">
            <label for="nombre">Nombre *</label>
            <input type="text" id="nombre" name="nombre" required autocomplete="name" aria-describedby="nombre-error" value="{{ registro.nombre }}" />
            <div id="nombre-error" class="error-message" role="alert" aria-live="polite"></div>
          </div>
          <div class="form-group">
            <label for="email">Correo electrónico *</label>
            <input type="email" id="email" name="email" required autocomplete="email" aria-describedby="email-error" value="{{ registro.email }}" />
            <div id="email-error" class="error-message" role="alert" aria-live="polite"></div>
          </div>
          <div class="form-group">
            <label for="fecha">Fecha *</label>
            <input type="date" id="fecha" name="fecha" required aria-describedby="fecha-error" value="{{ registro.fecha }}" />
            <div id="fecha-error" class="error-message" role="alert" aria-live="polite"></div>
          </div>
          <div class="form-group">
            <label for="ciudad">Ciudad *</label>
            <input type="text" id="ciudad" name="ciudad" required autocomplete="address-level2" aria-describedby="ciudad-error" value="{{ registro.ciudad }}" />
            <div id="ciudad-error" class="error-message" role="alert" aria-live="polite"></div>
          </div>
          <div class="form-group">
            <label for="pais">País *</label>
            <select id="pais" name="pais" required aria-describedby="pais-error">
              <option value="">Seleccione un país</option>
              <option value="Ecuador" {% if registro.pais == 'Ecuador' %}selected{% endif %}>Ecuador</option>
              <option value="Colombia" {% if registro.pais == 'Colombia' %}selected{% endif %}>Colombia</option>
              <option value="Perú" {% if registro.pais == 'Perú' %}selected{% endif %}>Perú</option>
              <option value="Otro" {% if registro.pais == 'Otro' %}selected{% endif %}>Otro</option>
            </select>
            <div id="pais-error" class="error-message" role="alert" aria-live="polite"></div>
          </div>
        </fieldset>
        <fieldset>
          <legend>Preferencias</legend>
          <div class="form-group">
            <label for="suscripcion">¿Desea recibir notificaciones?</label>
            <input type="checkbox" id="suscripcion" name="suscripcion" {% if registro.suscripcion %}checked{% endif %} />
          </div>
        </fieldset>
        <div class="form-actions">
          <button type="button" onclick="confirmarActualizar()" aria-label="Actualizar">Actualizar</button>
          <button type="button" onclick="window.location.href='/'" aria-label="Cancelar">Cancelar</button>
        </div>
        <div id="editar-exito" class="registro-exito" role="status" aria-live="polite" style="display:none; color:green; font-weight:bold; margin-top:1em;">¡Registro actualizado exitosamente!</div>
        <div id="editar-error" class="registro-error" role="alert" aria-live="polite" style="display:none; color:red; font-weight:bold; margin-top:1em;"></div>
        <div id="editar-sin-cambios" class="registro-exito" role="status" aria-live="polite" style="display:none; color:orange; font-weight:bold; margin-top:1em;">No se detectaron cambios.</div>
      </form>
    </div>
  </main>
<script>
// Guardar valores originales para detectar cambios
const original = {
  nombre: '{{ registro.nombre }}',
  email: '{{ registro.email }}',
  fecha: '{{ registro.fecha }}',
  ciudad: '{{ registro.ciudad }}',
  pais: '{{ registro.pais }}',
  suscripcion: {{ 'true' if registro.suscripcion else 'false' }}
};

// Validación en tiempo real y destacar cambios
function validarCampo(id, validador, mensaje) {
  const input = document.getElementById(id);
  const error = document.getElementById(id + '-error');
  if (!validador(input.value)) {
    error.textContent = mensaje;
    input.style.borderColor = 'red';
    return false;
  } else {
    error.textContent = '';
    input.style.borderColor = 'green';
    return true;
  }
}

function destacarCambio(id, valorOriginal) {
  const input = document.getElementById(id);
  if (input.type === 'checkbox') {
    if (input.checked != valorOriginal) {
      input.style.outline = '2px solid orange';
    } else {
      input.style.outline = '';
    }
  } else {
    if (input.value != valorOriginal) {
      input.style.outline = '2px solid orange';
    } else {
      input.style.outline = '';
    }
  }
}

const form = document.getElementById('form-editar');
form.addEventListener('input', function(e) {
  if (e.target.id === 'nombre') {
    validarCampo('nombre', v => v.length > 1, 'Nombre requerido');
    destacarCambio('nombre', original.nombre);
  }
  if (e.target.id === 'email') {
    validarCampo('email', v => /.+@.+\..+/.test(v), 'Correo inválido');
    destacarCambio('email', original.email);
  }
  if (e.target.id === 'fecha') {
    validarCampo('fecha', v => v.length > 0, 'Fecha requerida');
    destacarCambio('fecha', original.fecha);
  }
  if (e.target.id === 'ciudad') {
    validarCampo('ciudad', v => v.length > 1, 'Ciudad requerida');
    destacarCambio('ciudad', original.ciudad);
  }
  if (e.target.id === 'pais') {
    validarCampo('pais', v => v.length > 0, 'Seleccione un país');
    destacarCambio('pais', original.pais);
  }
  if (e.target.id === 'suscripcion') {
    destacarCambio('suscripcion', original.suscripcion);
  }
});

function mostrarError(mensaje) {
  const error = document.getElementById('editar-error');
  error.textContent = mensaje;
  error.style.display = 'block';
  setTimeout(() => { error.style.display = 'none'; }, 4000);
}

function mostrarExito() {
  document.getElementById('editar-exito').style.display = 'block';
  setTimeout(() => { document.getElementById('editar-exito').style.display = 'none'; }, 3000);
}

function mostrarSinCambios() {
  document.getElementById('editar-sin-cambios').style.display = 'block';
  setTimeout(() => { document.getElementById('editar-sin-cambios').style.display = 'none'; }, 3000);
}

function confirmarActualizar() {
  // Detectar cambios
  let cambios = false;
  if (document.getElementById('nombre').value != original.nombre) cambios = true;
  if (document.getElementById('email').value != original.email) cambios = true;
  if (document.getElementById('fecha').value != original.fecha) cambios = true;
  if (document.getElementById('ciudad').value != original.ciudad) cambios = true;
  if (document.getElementById('pais').value != original.pais) cambios = true;
  if (document.getElementById('suscripcion').checked != original.suscripcion) cambios = true;
  if (!cambios) {
    mostrarSinCambios();
    return;
  }
  // Confirmación previa si se edita el email
  if (document.getElementById('email').value != original.email) {
    if (!confirm('Está a punto de cambiar el correo electrónico. ¿Desea continuar?')) return;
  }
  // Validar todos los campos
  if (!validarCampo('nombre', v => v.length > 1, 'Nombre requerido') ||
      !validarCampo('email', v => /.+@.+\..+/.test(v), 'Correo inválido') ||
      !validarCampo('fecha', v => v.length > 0, 'Fecha requerida') ||
      !validarCampo('ciudad', v => v.length > 1, 'Ciudad requerida') ||
      !validarCampo('pais', v => v.length > 0, 'Seleccione un país')) {
    mostrarError('Por favor, corrige los errores antes de actualizar.');
    return;
  }
  // Simulación de actualización exitosa
  mostrarExito();
}

// Alerta si el usuario intenta salir sin guardar cambios
let formChanged = false;
form.addEventListener('change', () => { formChanged = true; });
window.addEventListener('beforeunload', function (e) {
  if (formChanged) {
    e.preventDefault();
    e.returnValue = '';
  }
});
</script>
</body>
</html> 